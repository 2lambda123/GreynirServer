
{% extends "container-normal.html" %}

{% block meta %}

<meta name="robots" content="noindex,nofollow" />

{% endblock %}

{% block styles %}

<link href="{{ url_for('static', filename='css/main-bootstrap.css') }}" rel='stylesheet' type='text/css'>

<link href="https://fonts.googleapis.com/css?family=Oswald:300,400" rel="stylesheet">

<style>

   h1#meta-heading {
      font-family: 'Oswald', 'Open Sans', sans-serif;
      font-weight: 400;
      font-size: 40px;
   }

   h3#meta-author {
      font-family: 'Oswald', 'Open Sans', sans-serif;
      font-weight: 300;
   }

   h4#meta-timestamp {
      font-weight: 400;
      font-size: 16px;
   }

   div#result-translation span i {
      font-style: italic;
      font-size: 1.05em;
   }
   div#result-translation span.good i:hover {
      background-color: #77FF77;
      color: black;
   }
   div#result-translation span.average i:hover {
      background-color: #777777;
      color: white;
   }
   div#result-translation span.bad i:hover {
      color: black;
      background-color: #FF7777;
   }
   div#result-translation span.translated i {
      font-style: normal;
   }
   span#spinner {
      color: #f0ad4e;
   }

</style>

{% endblock %}

{% block content %}
    {% if nn_translate_enabled -%}
    <div id="info-trnsl">
    </div>
    {%- endif -%}

<div id="output">

   <div id="column">
      <!-- Article heading and content -->

      <div id="metadata">
         <!-- Article metadata -->
         <div id="topics">

{% set labelmap = {
   "business" : "label-primary",
   "technology" : "label-primary",
   "sport" : "label-warning",
   "culture" : "label-warning",
   "politics" : "label-success",
   "economy" : "label-success",
   "health" : "label-info",
   "salmon" : "label-info",
   "weather" : "label-danger",
   "accidents" : "label-danger",
   "immigration" : "label-warning"
} %}

{% for t in topics -%}
            <span class="topic label {{ labelmap[t.id] }}"><span class="glyphicon glyphicon-tag"></span>{{ t.name }}</span>
{%- endfor -%}
         </div>
         <h1 id="meta-heading">{{ article.heading }}</h1>
         <h3 id="meta-author" class="text-muted">{{ article.author }}</h3>
         <h4 id="meta-timestamp" class="text-muted">{{ article.timestamp | format_ts }}</h4>
         <h5 id="meta-url">
            <a href="{{ article.url }}" target="_blank">Upphafleg grein
{%- if article.root_domain -%}
               <img src="{{ url_for('static', filename = 'sources/' + article.root_domain + '.png') }}" width="16" height="16">
{%- endif -%}
            </a>
            <button type="button" class="btn btn-warning" id="refresh" title="Endurgreina">
               <span class="glyphicon glyphicon-restart"></span>
            </button>
            {% if not config.PRODUCTION %}
            <button type="button" class="btn btn-info" id="check" title="Lesa yfir">
               <span class="glyphicon glyphicon-eye-open"></span>
            </button>
            {% endif %}

         </h5>
      </div>

     {% if nn_translate_enabled -%}
      <div id="language-tabs">
          <ul id="language-hdr" class="nav nav-tabs" role="tablist">
              <li role="presentation" class="active">
                  <a href="#translation-article-src" aria-controls="icelandic" role="tab" data-toggle="tab">
                      <!-- https://www.countryflags.com/en/iceland-flag-icon.html -->
                      <img src="{{ url_for('static', filename = 'flag/iceland-flag-icon-32.png') }}" width="32" height="20">&nbsp;Íslenska&nbsp;
                  </a>
              </li>
              <li role="presentation">
                  <a id="translate-tgt-btn" href="#translation-article-tgt" aria-controls="translation" role="tab" data-toggle="tab">
                      <!-- https://www.countryflags.com/en/united-states-flag-icon.html -->
                      <span><img src="{{ url_for('static', filename = 'flag/united-states-of-america-flag-icon-32.png') }}" width="32" height="20">&nbsp;Enska
                      </span>
                      &nbsp;<span id="spinner" style="display: none;" class='glyphicon glyphicon-restart glyphicon-spin-white'></span>
                  </a>
              </li>
              <li role="presentation" class="pull-right">
                  <div id="help">
                      <h4 class="help"><small>Smelltu á málsgrein til að sjá trjágreiningu hennar</small></h4>
                  </div>
              </li>
          </ul>
      </div>
     <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="translation-article-src">
           <div id="result" class="result">
             {% include 'hover-infobox.html' %}
             <div id="pgs">
                <!-- Result of analysis goes here -->
                <p>Sæki grein...
                   <span class="glyphicon glyphicon-restart glyphicon-spin"></span>
                </p>
             </div>

          </div>
        </div>
          <div role="tabpanel" class="tab-pane" id="translation-article-tgt">
              <div id="result-translation">
                  <!-- Translated article goes here -->
              </div>
          </div>
     </div>
 {% endif %}
   </div> <!-- column -->

   <div id="register">
      <!-- Name register goes here -->
      <h3>Nafnalisti</h3>
      <ul id="namelist"></ul>
   </div>

   <div id="similar">
      <!-- List of similar articles goes here -->
      <h3>Svipaðar greinar</h3>
      <ul id="similarlist">
{% for sa in similar %}
         <li>
            <span class="timestamp">{{ sa.ts_text }}</span>
            <img src="{{ url_for('static', filename = 'sources/' + sa.domain + '.png') }}" width="16" height="16">
            <a href="{{ url_for('routes.page', id = sa.uuid) }}"><span class="heading">{{ sa.heading }}</span></a>
            <span class="similarity">{{ sa.similarity | format_is(1) }}%</span>
         </li>
{% endfor %}
      </ul>
   </div>

   <div id="statistics">
      <!-- Statistics go here -->
      <h3>Tölfræði</h3>
      <ul>
         <li>Textinn inniheldur <span id="tok-num">0</span> eindir í
            <span id="num-sent">0</span> málsgreinum.</li>
         <li>Það tókst að trjágreina <span id="num-parsed-sent">0</span> málsgreinar eða
            <span id="num-parsed-ratio">0,0</span>%.</li>
         <li>Margræðnistuðull var
            <span id="avg-ambig-factor">1,00</span>.</li>
      </ul>
   </div>

</div>

{% endblock %}

{% block endscripts %}

<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/page.js') }}"></script>

<script>

   // Include the tokens in the page script as a JSON structure
   // noinspection SyntaxError
   var j =
      {{ article.tokens | safe }}
      ;

   {% if nn_translate_enabled -%}
    var BATCH_SIZE = 10;
    var batches = [];
    var batch_queue = [];
    var sent_map = {};
    var pg_map = {};
    var is_translating = false;
    function hoverInTranslation(ev) {
        var sId = $(this).parent().attr("id");
        if (sId === null || sId === undefined || !sent_map || !sId.startsWith("trnsl")) {
           // No id: nothing to do
           return;
        }
        var offset = $(this).position();
        height = $(this).outerHeight();
        bottom = offset.top + height;
        sent_idx = sId.replace("trnsl","");
        $("#info-trnsl").html(sent_map[sent_idx]["is"]);
        // Position the info popup
        $("#info-trnsl")
            .css("top", bottom + "px")
            .css("left", offset.left.toString() + "px")
            .css("visibility", "visible");
    }
    function hoverOutTranslation() {
        $("#info-trnsl").css("visibility", "hidden");
        $("#info-trnsl").html("")
    }
    function wait_translation(state) {
        // Start or stop a wait spinner when awaiting translation
        // True means spinner is active
        if (state) {
            $("#spinner").show();
        }
        else {
            $("#spinner").hide();
        }
    }
    function extract_segmented_paragraphs(pgs_obj) {
       /* Extract article text and segment into paragraphs
          and sentences returns:
             map of
                map from sentence_id to sent_obj
                map from pgs_id to array of sent_obj */
       var pg_map = {};
       var sent_map = {};
       var sent_idx = 1
       $.each(pgs_obj, function (pg_cursor, pg_obj) {
           pg_map[pg_cursor] = []
           $.each(pg_obj, function (sent_cursor, sent_obj) {
               var toks = [];
               $.each(sent_obj, function (tok_cursor, tok_obj) {
                   if (tok_obj.hasOwnProperty("x")) {
                       toks.push(tok_obj.x);
                   }
               });
               sent_map[sent_idx] = {is: toks.join(" ")}
               pg_map[pg_cursor].push(sent_idx)
               sent_idx++;
           });
        });
        return {
            "pg_map": pg_map,
            "sent_map": sent_map
        }
    }
    function populateTargets(pg_map, sent_map) {
        var pg_container = $("div#result-translation");
        $.each(pg_map, function (pg_idx, sent_key) {
            var pg_elem = $("<p></p>");
            $.each(pg_map[pg_idx], function (sent_cursor, sent_idx) {
                var sent_elem = $("<i></i>", {
                    "text": sent_map[sent_idx]["is"]
                });
                var sent_container = $("<span></span>", {
                    "id": "trnsl" + sent_idx,
                    "class": "sent"
                });
                sent_container.append(sent_elem);
                pg_elem.append(sent_container);
            });
            pg_container.append(pg_elem);
        });
        $("div#result-translation i").hover(hoverInTranslation, hoverOutTranslation);
    }

    function make_batches(sent_map, batch_size) {
        var parseIntDec = function (str) { return parseInt(str, 10) };
        var cmpInt = function (a, b) { return a - b };
        var isInt = function (n) { return !isNaN(n) };
        var idxs = Object.keys(sent_map)
                         .map(parseIntDec)
                         .filter(isInt)
                         .sort(cmpInt);
        var batches = [];
        var batch = {};
        var idx = 0;
        var count = 0;
        while (idx < idxs.length ) {
            if (count < batch_size) {
                if (sent_map[idx].hasOwnProperty("en")) {
                    idx++;
                    continue;
                }
                batch[idx] = sent_map[idx]["is"];
                idx++;
                count++;
            }
            else {
                batches.push(batch);
                batch = {};
                count = 0;
            }
        }
        if (count > 0) {
            batches.push(batch);
        }
        return batches;
    }
    function translateNext() {
        if (batch_queue.length > 0 && is_translating) {
            var batch_idx = batch_queue.pop();
            var batch = batches[batch_idx];
            translateBatch(batch, translateNext);
        } else {
            wait_translation(false);
        }
    }
    function translateBatch(batch, callback) {
        serverJsonQuery("{{ url_for('routes.nntranslate_api') }}", // Endpoint with .api suffix are not cached
                    {
                        pgs : batch,
                        src_lang : "is",
                        tgt_lang : "en",
                    },
                    function handleSuccess(json) {
                        results = json.result.results;
                        populateBatchResults(results, callback);
                        wait_translation(false);
                    },
                    null,
                    function handleError(json) {
                        console.log(json)
                        wait_translation(false);
                    }
        );
    }
    function populateBatchResults(results, callback) {
        $.each(results, function (sent_key, obj) {
            outputs = obj.outputs;
            inputs = obj.inputs;
            scores = obj.scores;
            score_class = scoreClass(scores);
            if (sent_key !== "0") {
                // we need to handle article title seperately
                sent_map[sent_key]["is"] = inputs;
                sent_map[sent_key]["en"] = outputs;
                sent_map[sent_key]["scores"] = scores;
                $("#trnsl" + sent_key).addClass("translated " + score_class)
                                        .children("i")
                                        .eq(0)
                                        .text(outputs)
            } else {
                // replace article head
                $("#meta-heading").text(obj.outputs)
            }
        });
        callback();
    }
    function scoreClass(_score) {
        score = parseFloat(_score);
        if (score <= -8.5) {
            return "bad err"
        } else if (score <= -4.0) {
            return "average"
        } else {
            return "good"
        }
    }

    function doTranslation() {
        // Submit the contents of the article incrementally
        // to the server for translation
        if ($.isEmptyObject(sent_map)) {
            wait_translation(true);
            var pg_seg = extract_segmented_paragraphs(j);
            pg_map = pg_seg["pg_map"];
            sent_map = pg_seg["sent_map"];
            var a_title = $("#meta-heading").text()
            sent_map[0] = a_title;
            populateTargets(pg_map, sent_map);
            batches = make_batches(sent_map, BATCH_SIZE);
            batch_queue = Array.from(Array(batches.length).keys()).reverse()
            is_translating = true;
            translateNext();
        } else {
            is_translating = true;
            batches = make_batches(sent_map, BATCH_SIZE);
            batch_queue = Array.from(Array(batches.length).keys()).reverse()
            translateNext();
        }
    }

    function showOriginalArticle() {
        if (!$.isEmptyObject(sent_map)) {
            is_translating = false;
            $("#meta-heading").text(sent_map[0])
        }
    }
{%- endif %}

   // Name and title list
   nameDict = {{ register | tojson | safe }};

   // Article statistics
   var stats = {
      num_tokens: {{ article.num_tokens }},
      num_sentences: {{ article.num_sentences }},
      num_parsed: {{ article.num_parsed }},
      ambiguity: {{ article.ambiguity }}
   };

   function handleError(xhr, status, errorThrown) {
      /* An error occurred on the server or in the communications */
      $("div#help").css("display", "none");
      $("div#pgs").html("<p><b>Villa kom upp</b> í samskiptum við netþjón Greynis</p>");
      $("button#refresh").removeAttr("disabled");
      $("button#check").removeAttr("disabled");
   }

   function populateArticle(json) {
      var jResult = null;
      if (!!json.result)
         // The JSON arrives as a string in the result field
         jResult = $.parseJSON(json.result);
      j = jResult;
      displayTokens(jResult);
      // Show help text
      $("div#help").css("display", "block");
      // Display similar articles
      $("div#similar").css("display", "block");
      // Show statistics
      populateStats(json.stats);
      $("div#statistics").css("display", "block");
      nameDict = json.register;
      populateRegister();
      $("button#refresh").removeAttr("disabled");
      $("button#check").removeAttr("disabled");
   }

   function reparseArticle(uuid) {
      // Ask the server to scrape, tokenize and parse a fresh URL
      // Launch the query
      $("div#help").css("display", "none");
      $("div#pgs").html("<p>Málgreining stendur yfir... " +
         "<span class='glyphicon glyphicon-restart glyphicon-spin'></span>" +
         "</p>");
      $("button#refresh").attr("disabled", "disabled");
      $("button#check").attr("disabled", "disabled");
      $("div#statistics").css("display", "none");
      $("div#register").css("display", "none");
      $("div#similar").css("display", "none");
      serverQuery('/reparse.api', // Endpoints with .api suffix are not cached
         {
            id : uuid
         },
         populateArticle,
         null,
         handleError
      );
   }

   function checkArticle() {
      // Send the text of the current article over to correct.html
      // for spelling and grammar checking
      var txt = "";
      $.each($("div#pgs p"), function() {
         // Handle each paragraph
         var ptxt = "";
         $.each($("span.sent", this), function () {
            // Handle each sentence
            ptxt += $(this).text() + " ";
         });
         txt += ptxt + "\n\n";
      });
      // POST to the /correct page
      serverPost("/correct", { txt: txt });
   }

   function init() {
      // Show help text
      $("div#help").show();
      $("button#refresh").click(function(ev) {
         reparseArticle("{{ article.uuid | safe }}");
      });
      $("button#check").click(checkArticle);
      displayTokens(j);
      // Show similar list
      $("div#similar").show();
      // Show statistics
      populateStats(stats);
      $("div#statistics").show();
      populateRegister();

       $('#lang-hdr a').click(function() {
          $(this).tab('show');
      });
      $('#lang-hdr a:first').tab('show');
   }

   {% if nn_translate_enabled -%}
        $("#translate-tgt-btn").click(function (item) {
            doTranslation();
        });
        $("#translation-article-src").click(function (item) {
            showOriginalArticle();
        });
    {% endif %}

   $(document).ready(init);

</script>

{% endblock %}

